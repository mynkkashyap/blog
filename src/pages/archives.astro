---
import Layout from "~/layouts/PageLayout.astro";

// Load all MD posts
const postFiles = import.meta.glob("~/data/post/*.md", { eager: true });

// Extract posts
const posts = Object.entries(postFiles).map(([path, post]) => {
  // Example filename: 2025-11-13-acute-appendicitis.md
  const file = path.split("/").pop(); // "2025-11-13-acute-appendicitis.md"
  const base = file.replace(".md", ""); // "2025-11-13-acute-appendicitis"

  // Extract date from beginning of filename
  // Format: YYYY-MM-DD-title
  const [year, month, day, ...titleParts] = base.split("-");
  const slug = base; // this matches your URL exactly

  // Build date object safely
  let date = null;
  if (year && month && day) {
    const iso = `${year}-${month}-${day}`;
    const d = new Date(iso);
    if (!isNaN(d)) date = d;
  }

  return {
    title: post.frontmatter?.title ?? titleParts.join(" "),
    slug,
    date,
    year,
    description: post.frontmatter?.description || "",
  };
});

// Group posts by year
const grouped = {};
for (const p of posts) {
  if (!p.year) continue;
  if (!grouped[p.year]) grouped[p.year] = [];
  grouped[p.year].push(p);
}

// Sort years descending
const years = Object.keys(grouped).sort((a, b) => b - a);

// Sort posts inside each year by date
for (const y of years) {
  grouped[y].sort((a, b) => (b.date - a.date));
}

const metadata = { title: "Archives" };
---

<Layout metadata={metadata}>
  <section class="max-w-4xl mx-auto px-4 py-10">
    <h1 class="text-3xl font-bold mb-8">Year-wise Archives</h1>

    {years.map((year) => (
      <div class="mb-10">
        <h2 class="text-2xl font-bold mb-4">{year}</h2>

        <ul class="space-y-4">
          {grouped[year].map((post) => (
            <li class="border-b pb-3">
              <a href={`/${post.slug}/`} class="block">
                <h3 class="text-lg font-semibold hover:underline">{post.title}</h3>

                <p class="text-sm text-gray-500">
                  {post.date ? post.date.toLocaleDateString() : ""}
                </p>

                {post.description && (
                  <p class="text-gray-600 mt-1">{post.description}</p>
                )}
              </a>
            </li>
          ))}
        </ul>
      </div>
    ))}
  </section>
</Layout>
